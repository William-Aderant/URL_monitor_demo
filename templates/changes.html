{% extends "base.html" %}

{% block title %}Changes - PDF Monitor{% endblock %}

{% block content %}
<h1>Recent Changes</h1>

{% if changes %}
<div class="card">
    <table>
        <thead>
            <tr>
                <th>URL</th>
                <th>Change Type</th>
                <th>Classification</th>
                <th>Similarity</th>
                <th>Detected</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for item in changes %}
            <tr class="{% if not item.change.reviewed and item.change.change_type != 'new' %}row-changed{% endif %}{% if item.change.relocated_from_url %} row-relocated{% endif %}{% if item.change.change_type == 'relocation_failed' %} row-error{% endif %}">
                <td>
                    <div class="card-title">{{ item.url_name }}</div>
                    {% if item.change.relocated_from_url %}
                    <div style="margin-top: 6px; padding: 6px; background: rgba(255, 193, 7, 0.15); border-left: 3px solid var(--warning); border-radius: 4px; font-size: 0.75rem;">
                        <div style="color: var(--text-secondary); margin-bottom: 2px;">üìç URL Changed:</div>
                        <div style="color: var(--text-primary);">
                            <span style="text-decoration: line-through; opacity: 0.6;">{{ item.change.relocated_from_url[:50] }}{% if item.change.relocated_from_url|length > 50 %}...{% endif %}</span>
                            <span style="margin: 0 4px;">‚Üí</span>
                            <span style="font-weight: 600;">{{ item.url_url[:50] }}{% if item.url_url|length > 50 %}...{% endif %}</span>
                        </div>
                    </div>
                    {% endif %}
                    {% if item.change.change_type == 'relocation_failed' %}
                    <div style="margin-top: 6px; padding: 6px; background: rgba(244, 33, 46, 0.15); border-left: 3px solid var(--error); border-radius: 4px; font-size: 0.75rem;">
                        <div style="color: var(--text-secondary); margin-bottom: 2px;">‚ö†Ô∏è Relocation Failed:</div>
                        <div style="color: var(--text-primary);">
                            Form is inaccessible. Relocation search could not find the form at a new location.
                        </div>
                        {% if item.change.diff_summary %}
                        <div style="color: var(--text-secondary); margin-top: 4px; font-size: 0.7rem;">
                            {{ item.change.diff_summary }}
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                </td>
                <td>
                    <span class="badge {% if item.change.change_type == 'new' %}badge-info{% elif item.change.change_type == 'text_changed' %}badge-warning{% elif item.change.change_type == 'format_only' %}badge-neutral{% elif item.change.change_type == 'relocation_failed' %}badge-error{% else %}badge-success{% endif %}">
                        {{ item.change.change_type|replace('_', ' ')|title }}
                    </span>
                    {% if item.change.relocated_from_url %}
                    <span class="badge badge-relocated" style="margin-left: 4px; font-size: 0.65rem;">üìç URL Changed</span>
                    {% endif %}
                    {% if item.change.change_type == 'relocation_failed' %}
                    <span class="badge badge-error" style="margin-left: 4px; font-size: 0.65rem;">üîç Not Found</span>
                    {% endif %}
                </td>
                <td>
                    {# PoC-aligned classification labels #}
                    {% if item.change.match_type == 'form_number_match' %}
                        <span class="badge badge-success" style="font-size: 0.7rem;">üìã Updated Form (Same Name)</span>
                    {% elif item.change.match_type == 'similarity_match' %}
                        <span class="badge badge-info" style="font-size: 0.7rem;">üìä Updated Form (Name Change)</span>
                    {% elif item.change.match_type == 'new_form' %}
                        <span class="badge badge-error" style="font-size: 0.7rem;">üÜï New Form</span>
                    {% elif item.change.match_type == 'uncertain' %}
                        <span class="badge badge-warning" style="font-size: 0.7rem;">‚ùì Needs Review</span>
                    {% elif item.change.change_type == 'new' %}
                        <span class="badge badge-info" style="font-size: 0.7rem;">üÜï New Form</span>
                    {% else %}
                        <span style="color: var(--text-secondary);">‚Äî</span>
                    {% endif %}
                </td>
                <td>
                    {% if item.change.similarity_score %}
                        <span style="font-weight: 600;">{{ (item.change.similarity_score * 100)|round|int }}%</span>
                    {% else %}
                        <span style="color: var(--text-secondary);">‚Äî</span>
                    {% endif %}
                </td>
                <td>
                    <span class="timestamp">{{ item.change.detected_at.strftime('%Y-%m-%d %H:%M') }}</span>
                </td>
                <td>
                    <a href="/url/{{ item.change.monitored_url_id }}" class="btn btn-secondary btn-sm">View URL</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% else %}
<div class="card">
    <div class="empty-state">
        <div class="empty-state-icon">üìä</div>
        <h2>No Changes Yet</h2>
        <p>Run a monitoring cycle to start detecting changes.</p>
    </div>
</div>
{% endif %}
{% endblock %}


