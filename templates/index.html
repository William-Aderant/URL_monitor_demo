{% extends "base.html" %}

{% block title %}Dashboard - PDF Monitor{% endblock %}

{% block content %}
<h1>Monitored URLs</h1>

{% if message %}
<div class="card" style="margin-bottom: 24px; {% if message_type == 'error' %}background: rgba(244, 33, 46, 0.1); border-left: 4px solid var(--error);{% else %}background: rgba(0, 186, 124, 0.1); border-left: 4px solid var(--success);{% endif %}">
    <div style="display: flex; align-items: center; gap: 12px;">
        <span style="font-size: 1.5rem;">{% if message_type == 'error' %}‚ùå{% else %}‚úÖ{% endif %}</span>
        <div>
            <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">
                {% if message_type == 'error' %}Error{% else %}Success{% endif %}
            </div>
            <div style="color: var(--text-secondary); font-size: 0.9rem;">{{ message }}</div>
        </div>
    </div>
</div>
{% endif %}

{# State Filter Tabs #}
{% if state_counts %}
<div class="state-tabs" style="margin-bottom: 24px; display: flex; flex-wrap: wrap; gap: 8px;">
    <a href="/" class="state-tab {% if not current_state %}active{% endif %}" style="
        padding: 10px 20px;
        background: {% if not current_state %}var(--accent){% else %}var(--bg-secondary){% endif %};
        color: {% if not current_state %}white{% else %}var(--text-secondary){% endif %};
        border-radius: 8px;
        text-decoration: none;
        font-weight: 600;
        font-size: 0.875rem;
        border: 1px solid {% if not current_state %}var(--accent){% else %}var(--border){% endif %};
        transition: all 0.2s;
    ">
        All States <span style="opacity: 0.8; margin-left: 6px;">({{ total_count }})</span>
    </a>
    {% for state_name, count in state_counts %}
    <a href="/?state={{ state_name }}" class="state-tab {% if current_state == state_name %}active{% endif %}" style="
        padding: 10px 20px;
        background: {% if current_state == state_name %}var(--accent){% else %}var(--bg-secondary){% endif %};
        color: {% if current_state == state_name %}white{% else %}var(--text-secondary){% endif %};
        border-radius: 8px;
        text-decoration: none;
        font-weight: 600;
        font-size: 0.875rem;
        border: 1px solid {% if current_state == state_name %}var(--accent){% else %}var(--border){% endif %};
        transition: all 0.2s;
    ">
        {{ state_name }} <span style="opacity: 0.8; margin-left: 6px;">({{ count }})</span>
    </a>
    {% endfor %}
</div>
{% endif %}

{# Domain Filter (shown when a state is selected and has multiple domains) #}
{% if current_state and domain_counts and domain_counts|length > 1 %}
<div class="domain-filter card" style="margin-bottom: 24px; padding: 16px;">
    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
        <span style="font-weight: 600; color: var(--text-primary);">Filter by Domain:</span>
        {% if current_domain %}
        <a href="/?state={{ current_state }}" class="btn btn-sm btn-secondary" style="font-size: 0.75rem;">
            Clear Filter
        </a>
        {% endif %}
    </div>
    <div style="display: flex; flex-wrap: wrap; gap: 8px; max-height: 200px; overflow-y: auto;">
        {% for domain_name, count in domain_counts %}
        <a href="/?state={{ current_state }}&domain={{ domain_name }}" 
           class="domain-chip {% if current_domain == domain_name %}active{% endif %}" 
           style="
            padding: 6px 12px;
            background: {% if current_domain == domain_name %}var(--accent){% else %}var(--bg-tertiary){% endif %};
            color: {% if current_domain == domain_name %}white{% else %}var(--text-secondary){% endif %};
            border-radius: 20px;
            text-decoration: none;
            font-size: 0.8rem;
            border: 1px solid {% if current_domain == domain_name %}var(--accent){% else %}var(--border){% endif %};
            transition: all 0.2s;
           ">
            {{ domain_name }} <span style="opacity: 0.7;">({{ count }})</span>
        </a>
        {% endfor %}
    </div>
</div>
{% endif %}

{# Search Filter #}
<div class="search-filter" style="margin-bottom: 24px;">
    <input type="text" 
           id="searchInput" 
           placeholder="Search URLs by name, form number, or URL..." 
           style="
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
           "
           oninput="filterTable()">
</div>

{# Action Buttons - Moved to top for easy access #}
<div style="margin-bottom: 24px; display: flex; align-items: center; gap: 12px;">
    <form id="monitorForm" action="/monitor/run" method="post" style="display: inline;" onsubmit="showMonitoringProgress()">
        <button type="submit" id="monitorBtn" class="btn btn-primary">
            ‚ñ∂ Run Monitoring Cycle
        </button>
    </form>
    <div id="monitorProgress" style="display: none; padding: 12px; background: var(--bg-secondary); border-radius: 6px;">
        <div style="display: flex; align-items: center; gap: 12px;">
            <div style="width: 20px; height: 20px; border: 3px solid var(--accent); border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <span style="color: var(--text-primary);">Running monitoring cycle... This may take a moment.</span>
        </div>
    </div>
</div>

{% if urls %}
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-value">{{ urls|length }}</div>
        <div class="stat-label">{% if current_state %}{{ current_state }} {% endif %}URLs{% if current_domain %} ({{ current_domain }}){% endif %}</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ urls|selectattr('url.enabled')|list|length }}</div>
        <div class="stat-label">Enabled</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ urls|sum(attribute='version_count') }}</div>
        <div class="stat-label">Total Versions</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ urls|selectattr('recent_change')|list|length }}</div>
        <div class="stat-label">With Changes</div>
    </div>
</div>

<div class="card" style="overflow-x: auto;">
    <table id="urlTable" style="table-layout: fixed; width: 100%; min-width: 900px;">
        <thead>
            <tr>
                <th style="width: 60px;">Preview</th>
                <th style="width: 35%;">Name / Formatted Title</th>
                {% if not current_state %}
                <th style="width: 80px;">State</th>
                {% endif %}
                <th style="width: 150px;">Status</th>
                <th style="width: 70px;">Versions</th>
                <th style="width: 120px;">Last Checked</th>
                <th style="width: 100px;">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for item in urls %}
            <tr class="url-row {% if item.recent_change and item.recent_change.change_type != 'new' and not item.recent_change.reviewed %}row-changed{% endif %}{% if item.recent_change and item.recent_change.relocated_from_url and not item.recent_change.reviewed %} row-relocated{% endif %}{% if item.recent_change and item.recent_change.change_type == 'relocation_failed' %} row-error{% endif %}"
                data-name="{{ item.url.name|lower }}"
                data-url="{{ item.url.url|lower }}"
                data-form="{{ item.latest_version.form_number|lower if item.latest_version and item.latest_version.form_number else '' }}"
                data-title="{{ item.latest_version.formatted_title|lower if item.latest_version and item.latest_version.formatted_title else '' }}">
                <td>
                    {% if item.latest_version %}
                    <a href="/url/{{ item.url.id }}" title="View details">
                        <img src="/api/urls/{{ item.url.id }}/versions/{{ item.latest_version.id }}/preview" 
                             alt="Preview" 
                             class="preview-thumbnail"
                             style="width: 50px; height: 65px; object-fit: cover; border: 1px solid var(--border); border-radius: 4px;"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div style="display: none; width: 50px; height: 65px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 4px; align-items: center; justify-content: center; font-size: 1.5rem;">üìÑ</div>
                    </a>
                    {% else %}
                    <div style="width: 50px; height: 65px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">üìÑ</div>
                    {% endif %}
                </td>
                <td style="overflow: hidden; text-overflow: ellipsis;">
                    {% if item.latest_version and item.latest_version.formatted_title %}
                    {# Use extracted title as primary display #}
                    <div class="card-title" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                        <span style="color: var(--text-primary); font-weight: 500;">{{ item.latest_version.display_title or item.latest_version.formatted_title }}</span>
                        {% if item.latest_version.title_confidence %}
                        <span style="color: var(--text-secondary); font-size: 0.75rem; margin-left: 6px;">
                            {{ (item.latest_version.title_confidence * 100)|round|int }}%
                        </span>
                        {% endif %}
                    </div>
                    {% if item.latest_version.revision_date %}
                    <div style="margin-top: 2px; font-size: 0.75rem; color: var(--text-secondary);">
                        Rev. {{ item.latest_version.revision_date }}
                    </div>
                    {% endif %}
                    {# Show URL name as secondary info when we have extracted title #}
                    <div style="margin-top: 4px; font-size: 0.75rem; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                        {{ item.url.name }}
                    </div>
                    {% else %}
                    {# Fallback to URL name if no extracted title #}
                    <div class="card-title" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-secondary);">{{ item.url.name }}</div>
                    {% endif %}
                    <div class="card-subtitle" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                        <a href="{{ item.url.url }}" target="_blank" class="url-link" title="{{ item.url.url }}">{{ item.url.url[:40] }}{% if item.url.url|length > 40 %}...{% endif %}</a>
                        {% if item.url.domain_category and not current_state %}
                        <span class="badge badge-neutral" style="margin-left: 4px; font-size: 0.6rem;">{{ item.url.domain_category[:20] }}</span>
                        {% endif %}
                    </div>
                </td>
                {% if not current_state %}
                <td>
                    {% if item.url.state %}
                    <a href="/?state={{ item.url.state }}" class="badge badge-info" style="text-decoration: none;">{{ item.url.state }}</a>
                    {% else %}
                    <span class="badge badge-neutral">Unknown</span>
                    {% endif %}
                </td>
                {% endif %}
                <td style="vertical-align: top;">
                    {% if item.url.enabled %}
                        {% if item.recent_change and item.recent_change.change_type != 'new' and not item.recent_change.reviewed %}
                            {# Unapproved change - show as Changed with pending review #}
                            {% if item.recent_change.change_type == 'relocation_failed' %}
                                <span class="badge badge-error">‚ö†Ô∏è Relocation Failed</span>
                                <div style="margin-top: 4px; font-size: 0.65rem; color: var(--error);">
                                    üîç Form inaccessible
                                </div>
                            {% else %}
                                <span class="badge badge-warning">{{ item.recent_change.change_type|replace('_', ' ')|title }}</span>
                            {% endif %}
                            {% if item.recent_change.match_type %}
                            <div style="margin-top: 4px;">
                                {% if item.recent_change.match_type == 'form_number_match' %}
                                    <span class="badge badge-success" style="font-size: 0.6rem;">üìã Same Name</span>
                                {% elif item.recent_change.match_type == 'similarity_match' %}
                                    <span class="badge badge-info" style="font-size: 0.6rem;">üìä Name Change</span>
                                {% elif item.recent_change.match_type == 'new_form' %}
                                    <span class="badge badge-error" style="font-size: 0.6rem;">üÜï New</span>
                                {% elif item.recent_change.match_type == 'uncertain' %}
                                    <span class="badge badge-warning" style="font-size: 0.6rem;">‚ùì Review</span>
                                {% endif %}
                            </div>
                            {% endif %}
                            {% if item.recent_change.relocated_from_url %}
                            <div style="margin-top: 4px;">
                                <span class="badge badge-warning" style="font-size: 0.6rem;">üìç Moved</span>
                            </div>
                            {% endif %}
                            <div style="margin-top: 4px; font-size: 0.65rem; color: var(--text-secondary);">‚è≥ Pending</div>
                        {% elif item.version_count > 0 %}
                            <span class="badge badge-success">Unchanged</span>
                            {% if item.recent_change and item.recent_change.reviewed %}
                            <div style="margin-top: 4px; font-size: 0.65rem; color: var(--text-secondary);">‚úÖ Approved</div>
                            {% endif %}
                        {% else %}
                            <span class="badge badge-info">New</span>
                        {% endif %}
                    {% else %}
                        <span class="badge badge-neutral">Disabled</span>
                    {% endif %}
                </td>
                <td>{{ item.version_count }}</td>
                <td>
                    {% if item.url.last_checked_at %}
                        <span class="timestamp">{{ item.url.last_checked_at.strftime('%Y-%m-%d %H:%M') }}</span>
                    {% else %}
                        <span class="timestamp">Never</span>
                    {% endif %}
                </td>
                <td>
                    <a href="/url/{{ item.url.id }}" class="btn btn-secondary btn-sm">View Details</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    {# Show count of visible rows #}
    <div id="visibleCount" style="margin-top: 12px; padding: 8px; color: var(--text-secondary); font-size: 0.85rem; text-align: center;"></div>
</div>

{% else %}
<div class="card">
    <div class="empty-state">
        <div class="empty-state-icon">üìã</div>
        <h2>No URLs Found</h2>
        {% if current_state or current_domain %}
        <p>No URLs match the current filter. <a href="/" style="color: var(--accent);">Clear filters</a></p>
        {% else %}
        <p>Run <code>python cli.py seed</code> to add sample URLs, then <code>python cli.py run</code> to start monitoring.</p>
        {% endif %}
    </div>
</div>
{% endif %}

<script>
function filterTable() {
    const query = document.getElementById('searchInput').value.toLowerCase().trim();
    const rows = document.querySelectorAll('.url-row');
    let visibleCount = 0;
    
    rows.forEach(row => {
        const name = row.dataset.name || '';
        const url = row.dataset.url || '';
        const form = row.dataset.form || '';
        const title = row.dataset.title || '';
        
        const matches = !query || 
            name.includes(query) || 
            url.includes(query) || 
            form.includes(query) || 
            title.includes(query);
        
        row.style.display = matches ? '' : 'none';
        if (matches) visibleCount++;
    });
    
    // Update visible count
    const countEl = document.getElementById('visibleCount');
    if (countEl) {
        if (query) {
            countEl.textContent = `Showing ${visibleCount} of {{ urls|length }} URLs`;
        } else {
            countEl.textContent = '';
        }
    }
}

function showMonitoringProgress() {
    const btn = document.getElementById('monitorBtn');
    const progress = document.getElementById('monitorProgress');
    
    btn.disabled = true;
    btn.innerHTML = '‚è≥ Running...';
    progress.style.display = 'block';
    
    // The form will submit and redirect, but this gives immediate feedback
}

// Add spinner animation
const style = document.createElement('style');
style.textContent = `
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    .state-tab:hover {
        opacity: 0.9;
        transform: translateY(-1px);
    }
    .domain-chip:hover {
        opacity: 0.9;
        transform: translateY(-1px);
    }
`;
document.head.appendChild(style);

// Auto-hide success message after 5 seconds
{% if message and message_type == 'success' %}
setTimeout(function() {
    const msgDiv = document.querySelector('.card[style*="border-left: 4px solid var(--success)"]');
    if (msgDiv) {
        msgDiv.style.transition = 'opacity 0.5s';
        msgDiv.style.opacity = '0';
        setTimeout(() => msgDiv.remove(), 500);
    }
}, 5000);

// Scroll to top to show message
window.scrollTo({ top: 0, behavior: 'smooth' });
{% endif %}

// Force refresh if refresh parameter is present (remove it from URL)
if (window.location.search.includes('refresh=') || window.location.search.includes('error=')) {
    // Clean up URL after a moment
    setTimeout(function() {
        const url = new URL(window.location);
        url.searchParams.delete('refresh');
        url.searchParams.delete('error');
        window.history.replaceState({}, '', url);
    }, 100);
}
</script>
{% endblock %}
