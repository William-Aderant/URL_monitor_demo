{% extends "base.html" %}

{% block title %}{{ url.name }} - PDF Monitor{% endblock %}

{% block content %}
<div style="margin-bottom: 24px;">
    <a href="/" class="btn btn-secondary btn-sm">‚Üê Back to Dashboard</a>
</div>

<h1>{{ url.name }}</h1>

<div class="card" style="margin-bottom: 24px;">
    <div class="card-header">
        <div>
            <div class="card-title">URL Details</div>
            <div class="card-subtitle">
                <a href="{{ url.url }}" target="_blank" class="url-link">{{ url.url }}</a>
            </div>
        </div>
        <div>
            {% if url.enabled %}
                <span class="badge badge-success">Enabled</span>
            {% else %}
                <span class="badge badge-neutral">Disabled</span>
            {% endif %}
        </div>
    </div>
    
    {% if url.description %}
    <p style="color: var(--text-secondary); margin-bottom: 16px;">{{ url.description }}</p>
    {% endif %}
    
    <div class="stats-grid" style="margin-bottom: 0;">
        <div class="stat-card">
            <div class="stat-value">{{ versions|length }}</div>
            <div class="stat-label">Versions</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ changes|length }}</div>
            <div class="stat-label">Changes</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">
                {% if url.last_checked_at %}
                    {{ url.last_checked_at.strftime('%m/%d %H:%M') }}
                {% else %}
                    Never
                {% endif %}
            </div>
            <div class="stat-label">Last Checked</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ url.check_interval_hours }}h</div>
            <div class="stat-label">Check Interval</div>
        </div>
    </div>
</div>

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
    <div>
        <h2>Version History</h2>
        
        {% if versions %}
        <div class="card">
            <div class="version-timeline">
                {% for version in versions %}
                <div class="version-item {% if loop.last %}first{% endif %}">
                    <div style="display: flex; gap: 16px;">
                        <!-- Preview Image -->
                        <div style="flex-shrink: 0;">
                            <a href="/api/urls/{{ url.id }}/versions/{{ version.id }}/preview" target="_blank" title="View full preview">
                                <img src="/api/urls/{{ url.id }}/versions/{{ version.id }}/preview" 
                                     alt="Preview" 
                                     style="width: 80px; height: 104px; object-fit: cover; border: 1px solid var(--border); border-radius: 4px; cursor: zoom-in;"
                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                <div style="display: none; width: 80px; height: 104px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 4px; align-items: center; justify-content: center; font-size: 2rem;">üìÑ</div>
                            </a>
                        </div>
                        
                        <!-- Version Details -->
                        <div style="flex-grow: 1;">
                            <div class="card-title">Version {{ version.version_number }}</div>
                            <div class="card-subtitle">
                                {{ version.fetched_at.strftime('%Y-%m-%d %H:%M:%S') }}
                            </div>
                            
                            <!-- Formatted Title (PoC format: "Title {FormNumber}") -->
                            {% if version.formatted_title %}
                            <div style="margin-top: 8px; padding: 8px; background: var(--bg-secondary); border-radius: 4px;">
                                <div style="font-weight: 600; color: var(--text-primary);">
                                    {{ version.display_title or version.formatted_title }}
                                </div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 4px;">
                                    {% if version.revision_date %}
                                    <span style="margin-right: 8px;">üìÖ Rev. {{ version.revision_date }}</span>
                                    {% endif %}
                                    {% if version.title_confidence %}
                                    Confidence: {{ (version.title_confidence * 100)|round|int }}%
                                    {% if version.title_extraction_method %}
                                    ‚Ä¢ Extracted via {% if version.title_extraction_method == 'bda' %}BDA{% else %}Fallback{% endif %}
                                    {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                            
                            <div style="margin-top: 8px; font-size: 0.875rem; color: var(--text-secondary);">
                                <span>{{ version.page_count or 0 }} pages</span>
                                <span style="margin: 0 8px;">‚Ä¢</span>
                                <span>{{ version.text_length or 0 }} chars</span>
                                <span style="margin: 0 8px;">‚Ä¢</span>
                                <span>{{ version.extraction_method }}</span>
                                {% if version.ocr_used %}
                                    <span class="badge badge-warning" style="margin-left: 8px;">OCR</span>
                                {% endif %}
                            </div>
                            <div style="margin-top: 12px;">
                                <a href="/api/urls/{{ url.id }}/versions/{{ version.id }}/pdf" class="btn btn-secondary btn-sm" target="_blank">
                                    Original PDF
                                </a>
                                <a href="/api/urls/{{ url.id }}/versions/{{ version.id }}/pdf?normalized=true" class="btn btn-secondary btn-sm" target="_blank">
                                    Normalized PDF
                                </a>
                                <button onclick="extractTitle({{ url.id }}, {{ version.id }})" class="btn btn-secondary btn-sm" title="Re-extract title using AWS BDA">
                                    üîÑ Extract Title
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% else %}
        <div class="card">
            <div class="empty-state">
                <div class="empty-state-icon">üìÑ</div>
                <p>No versions yet. Run a monitoring cycle to fetch the first version.</p>
            </div>
        </div>
        {% endif %}
    </div>
    
    <div>
        <h2>Change Log</h2>
        
        {% if changes %}
        <div class="card">
            {% for change in changes %}
            <div class="{% if change.change_type != 'new' %}change-item-changed{% endif %}" style="{% if not loop.last %}border-bottom: 1px solid var(--border); margin-bottom: 16px; padding-bottom: 16px;{% endif %} {% if change.change_type != 'new' %}background: rgba(255, 255, 0, 0.1); padding: 12px; border-radius: 8px; border-left: 4px solid #ffd700;{% endif %}">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div>
                        <span class="badge {% if change.change_type == 'new' %}badge-info{% elif change.change_type == 'text_changed' %}badge-warning{% else %}badge-neutral{% endif %}">
                            {{ change.change_type|replace('_', ' ')|title }}
                        </span>
                        {% if change.relocated_from_url %}
                        <span class="badge badge-relocated" style="margin-left: 4px; background: rgba(255, 200, 0, 0.3); border: 1px solid #ffc800;">üìç URL Changed</span>
                        {% endif %}
                    </div>
                    <div class="timestamp">{{ change.detected_at.strftime('%Y-%m-%d %H:%M') }}</div>
                </div>
                
                {% if change.match_type or change.similarity_score %}
                <div style="margin-top: 10px; padding: 10px; background: var(--bg-secondary); border-radius: 6px;">
                    <div style="font-weight: 600; margin-bottom: 6px; color: var(--text-primary);">üîç Change Analysis</div>
                    
                    {% if change.match_type %}
                    <div style="margin-bottom: 6px;">
                        <span style="color: var(--text-secondary); font-size: 0.8rem;">Classification:</span>
                        {# PoC-aligned classification labels #}
                        {% if change.match_type == 'form_number_match' %}
                            <span class="badge badge-success">üìã Updated Form (Same Name)</span>
                        {% elif change.match_type == 'similarity_match' %}
                            <span class="badge badge-info">üìä Updated Form (Name Change)</span>
                        {% elif change.match_type == 'new_form' %}
                            <span class="badge badge-error">üÜï New Form</span>
                        {% elif change.match_type == 'uncertain' %}
                            <span class="badge badge-warning">‚ùì Needs Review</span>
                        {% else %}
                            <span class="badge badge-neutral">{{ change.match_type|replace('_', ' ')|title }}</span>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    {% if change.similarity_score %}
                    <div>
                        <span style="color: var(--text-secondary); font-size: 0.8rem;">Similarity:</span>
                        <div style="display: inline-block; width: 100px; height: 8px; background: var(--bg-tertiary); border-radius: 4px; margin-left: 8px; vertical-align: middle;">
                            <div style="width: {{ (change.similarity_score * 100)|round|int }}%; height: 100%; background: {% if change.similarity_score >= 0.8 %}var(--success){% elif change.similarity_score >= 0.5 %}var(--warning){% else %}var(--error){% endif %}; border-radius: 4px;"></div>
                        </div>
                        <span style="margin-left: 8px; font-weight: 600;">{{ (change.similarity_score * 100)|round|int }}%</span>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
                
                {% if change.relocated_from_url %}
                <div style="margin-top: 12px; padding: 10px; background: rgba(255, 200, 0, 0.15); border-left: 4px solid #ffc800; border-radius: 6px;">
                    <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 6px; font-size: 0.875rem;">
                        üìç URL Changed
                    </div>
                    <div style="font-size: 0.8rem; color: var(--text-primary); line-height: 1.5;">
                        <div style="margin-bottom: 4px;">
                            <span style="color: var(--text-secondary);">From:</span>
                            <a href="{{ change.relocated_from_url }}" target="_blank" class="url-link" style="text-decoration: line-through; opacity: 0.7; margin-left: 4px;">
                                {{ change.relocated_from_url }}
                            </a>
                        </div>
                        <div>
                            <span style="color: var(--text-secondary);">To:</span>
                            <a href="{{ url.url }}" target="_blank" class="url-link" style="font-weight: 600; margin-left: 4px;">
                                {{ url.url }}
                            </a>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                {% if change.affected_pages %}
                <div style="margin-top: 8px; font-size: 0.875rem; color: var(--text-secondary);">
                    Affected pages: {{ change.affected_pages|join(', ') }}
                </div>
                {% endif %}
                
                {% if change.diff_summary %}
                <div class="diff-preview" style="margin-top: 12px;">{{ change.diff_summary[:500] }}{% if change.diff_summary|length > 500 %}...{% endif %}</div>
                {% endif %}
                
                <!-- Actions -->
                <div style="margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap; align-items: center;">
                    {% if change.new_version_id and change.previous_version_id %}
                    <button onclick="showDiffViewer({{ url.id }}, {{ change.new_version_id }})" class="btn btn-warning btn-sm">
                        üîç View Visual Diff
                    </button>
                    {% endif %}
                    
                    {% if change.reviewed %}
                    <span class="badge badge-success" style="padding: 6px 12px;">
                        ‚úÖ Approved
                        {% if change.reviewed_at %}
                        <span style="font-size: 0.7rem; opacity: 0.8; margin-left: 4px;">
                            {{ change.reviewed_at.strftime('%m/%d %H:%M') }}
                        </span>
                        {% endif %}
                    </span>
                    <button onclick="unapproveChange({{ change.id }})" class="btn btn-secondary btn-sm" title="Remove approval">
                        ‚Ü©Ô∏è Undo
                    </button>
                    {% else %}
                    <button onclick="approveChange({{ change.id }})" class="btn btn-success btn-sm">
                        ‚úÖ Approve Change
                    </button>
                    {% endif %}
                </div>
                
                {% if change.review_notes %}
                <div style="margin-top: 8px; font-size: 0.8rem; color: var(--text-secondary); font-style: italic;">
                    üìù {{ change.review_notes }}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="card">
            <div class="empty-state">
                <div class="empty-state-icon">üìä</div>
                <p>No changes detected yet.</p>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Similar Forms Section -->
<div class="card" id="similar-forms-card" style="margin-top: 24px; display: none;">
    <div class="card-header">
        <div class="card-title">üîç Similar Forms</div>
    </div>
    <div id="similar-forms-content">
        <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
            Loading similar forms...
        </div>
    </div>
</div>

<!-- Similar Forms Section -->
<div class="card" id="similar-forms-card" style="margin-top: 24px; display: none;">
    <div class="card-header">
        <div class="card-title">üîç Similar Forms</div>
    </div>
    <div id="similar-forms-content">
        <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
            Loading similar forms...
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
    /* Visual diff modal */
    .diff-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        z-index: 1000;
        justify-content: center;
        align-items: center;
    }
    
    .diff-modal.active {
        display: flex;
    }
    
    .diff-modal-content {
        background: var(--bg-primary);
        border-radius: 12px;
        max-width: 95%;
        max-height: 90%;
        overflow: auto;
        position: relative;
        padding: 24px;
    }
    
    .diff-modal-close {
        position: absolute;
        top: 12px;
        right: 12px;
        background: var(--bg-tertiary);
        border: none;
        border-radius: 50%;
        width: 36px;
        height: 36px;
        cursor: pointer;
        font-size: 1.25rem;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .diff-modal-close:hover {
        background: var(--accent);
        color: white;
    }
    
    .diff-image {
        max-width: 100%;
        max-height: 70vh;
        width: auto;
        height: auto;
        object-fit: contain;
        border: 2px solid #ffd700;
        border-radius: 8px;
        box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
    }
    
    .diff-image.side-by-side {
        max-height: 75vh;
    }
    
    .diff-view-controls {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
        padding: 12px;
        background: var(--bg-secondary);
        border-radius: 8px;
        justify-content: center;
        align-items: center;
    }
    
    .diff-view-toggle {
        padding: 8px 16px;
        border: 1px solid var(--border-color);
        background: var(--bg-primary);
        color: var(--text-primary);
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.875rem;
        transition: all 0.2s;
    }
    
    .diff-view-toggle:hover {
        background: var(--bg-tertiary);
    }
    
    .diff-view-toggle.active {
        background: var(--accent);
        color: white;
        border-color: var(--accent);
    }
    
    .diff-legend {
        margin-top: 16px;
        padding: 12px;
        background: var(--bg-secondary);
        border-radius: 8px;
        display: flex;
        gap: 16px;
        justify-content: center;
        font-size: 0.875rem;
    }
    
    .diff-legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .diff-legend-swatch {
        width: 20px;
        height: 20px;
        border-radius: 4px;
    }
</style>

<!-- Diff Modal -->
<div id="diffModal" class="diff-modal" onclick="if(event.target === this) closeDiffViewer()">
    <div class="diff-modal-content">
        <button class="diff-modal-close" onclick="closeDiffViewer()">√ó</button>
        <h2 style="margin-bottom: 16px;">üîç Visual Diff - Changes Highlighted</h2>
        
        <!-- View Toggle Controls -->
        <div class="diff-view-controls">
            <button id="diffViewOverlay" class="diff-view-toggle active" onclick="switchDiffView('overlay')">
                üìä Overlay View
            </button>
            <button id="diffViewSideBySide" class="diff-view-toggle" onclick="switchDiffView('side-by-side')">
                ‚ÜîÔ∏è Side-by-Side
            </button>
        </div>
        
        <!-- Page Navigation -->
        <div id="diffPageNavigation" style="display: none; margin-bottom: 16px; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
            <div style="display: flex; align-items: center; justify-content: space-between; gap: 16px;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <button id="diffPrevPage" class="btn btn-secondary btn-sm" onclick="changeDiffPage(-1)" disabled>‚Üê Previous</button>
                    <span id="diffPageInfo" style="font-weight: 600; min-width: 120px; text-align: center;">
                        Page <span id="diffCurrentPage">1</span> of <span id="diffTotalPages">1</span>
                    </span>
                    <button id="diffNextPage" class="btn btn-secondary btn-sm" onclick="changeDiffPage(1)" disabled>Next ‚Üí</button>
                </div>
                <div id="diffAffectedPagesInfo" style="font-size: 0.875rem; color: var(--text-secondary);">
                    <span style="color: var(--warning); font-weight: 600;">‚ö†Ô∏è</span>
                    <span>Changes on pages: <span id="diffAffectedPagesList">-</span></span>
                </div>
            </div>
        </div>
        
        <div id="diffImageContainer" style="text-align: center;">
            <div id="diffLoading" style="padding: 40px; color: var(--text-secondary);">
                Loading diff image...
            </div>
            <img id="diffImage" class="diff-image" style="display: none;" alt="Visual diff showing changes">
        </div>
        <div class="diff-legend">
            <div class="diff-legend-item">
                <div class="diff-legend-swatch" style="background: rgba(255, 255, 0, 0.6);"></div>
                <span>Changed areas</span>
            </div>
            <div class="diff-legend-item">
                <div class="diff-legend-swatch" style="background: rgba(255, 200, 0, 1); border: 2px solid #ffd700;"></div>
                <span>Significant changes</span>
            </div>
        </div>
    </div>
</div>

<script>
async function extractTitle(urlId, versionId) {
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '‚è≥ Extracting...';
    
    try {
        const response = await fetch(`/api/urls/${urlId}/versions/${versionId}/extract-title`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            alert(`Title extracted successfully!\n\nTitle: ${data.formatted_title}\nForm: ${data.form_number || 'N/A'}\nConfidence: ${Math.round(data.confidence * 100)}%`);
            // Reload page to show updated title
            location.reload();
        } else {
            alert(`Title extraction failed: ${data.detail || 'Unknown error'}`);
        }
    } catch (error) {
        alert(`Error: ${error.message}`);
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

let diffViewerState = {
    urlId: null,
    versionId: null,
    currentPage: 0,
    totalPages: 1,
    affectedPages: [],
    viewMode: 'overlay'  // 'overlay' or 'side-by-side'
};

async function showDiffViewer(urlId, versionId) {
    const modal = document.getElementById('diffModal');
    const diffImage = document.getElementById('diffImage');
    const diffLoading = document.getElementById('diffLoading');
    const pageNav = document.getElementById('diffPageNavigation');
    
    // Show modal
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
    
    // Reset state
    diffViewerState.urlId = urlId;
    diffViewerState.versionId = versionId;
    diffViewerState.currentPage = 0;
    diffViewerState.viewMode = 'overlay';
    
    // Reset view toggle buttons
    document.getElementById('diffViewOverlay').classList.add('active');
    document.getElementById('diffViewSideBySide').classList.remove('active');
    
    // Show loading
    diffLoading.style.display = 'block';
    diffImage.style.display = 'none';
    pageNav.style.display = 'none';
    
    try {
        // First, get page info
        const infoResponse = await fetch(`/api/urls/${urlId}/versions/${versionId}/diff-info`);
        if (infoResponse.ok) {
            const info = await infoResponse.json();
            diffViewerState.totalPages = info.page_count || 1;
            diffViewerState.affectedPages = info.affected_pages || [];
            
            // Update UI
            // Note: affectedPages from API are 1-indexed, but we need to convert to 0-indexed for display
            document.getElementById('diffTotalPages').textContent = diffViewerState.totalPages;
            document.getElementById('diffAffectedPagesList').textContent = 
                diffViewerState.affectedPages.length > 0 
                    ? diffViewerState.affectedPages.join(', ')  // Already 1-indexed from API
                    : 'None';
            
            // Show navigation if multi-page
            if (diffViewerState.totalPages > 1) {
                pageNav.style.display = 'block';
                updatePageNavigation();
            }
        }
        
        // Load first page diff image
        await loadDiffPage(0);
    } catch (error) {
        diffLoading.innerHTML = `‚ùå Failed to load diff info: ${error.message}`;
    }
}

async function loadDiffPage(pageNum) {
    const diffImage = document.getElementById('diffImage');
    const diffLoading = document.getElementById('diffLoading');
    
    // Validate page number
    if (pageNum < 0 || pageNum >= diffViewerState.totalPages) {
        return;
    }
    
    diffViewerState.currentPage = pageNum;
    
    // Show loading
    diffLoading.style.display = 'block';
    diffImage.style.display = 'none';
    
    // Update page info
    document.getElementById('diffCurrentPage').textContent = pageNum + 1;
    updatePageNavigation();
    
    // Load diff image for this page based on current view mode
    const viewParam = diffViewerState.viewMode === 'side-by-side' ? '&view=side-by-side' : '';
    const imageUrl = `/api/urls/${diffViewerState.urlId}/versions/${diffViewerState.versionId}/diff-preview?page=${pageNum}${viewParam}`;
    diffImage.src = imageUrl;
    
    // Update image class based on view mode
    if (diffViewerState.viewMode === 'side-by-side') {
        diffImage.classList.add('side-by-side');
    } else {
        diffImage.classList.remove('side-by-side');
    }
    
    diffImage.onload = function() {
        diffLoading.style.display = 'none';
        diffImage.style.display = 'block';
    };
    
    diffImage.onerror = function() {
        diffLoading.innerHTML = `‚ùå Failed to load diff image for page ${pageNum + 1}.`;
    };
}

function switchDiffView(mode) {
    if (diffViewerState.viewMode === mode) {
        return; // Already in this mode
    }
    
    diffViewerState.viewMode = mode;
    
    // Update button states
    document.getElementById('diffViewOverlay').classList.toggle('active', mode === 'overlay');
    document.getElementById('diffViewSideBySide').classList.toggle('active', mode === 'side-by-side');
    
    // Reload current page with new view mode
    loadDiffPage(diffViewerState.currentPage);
}

function changeDiffPage(delta) {
    const newPage = diffViewerState.currentPage + delta;
    if (newPage >= 0 && newPage < diffViewerState.totalPages) {
        loadDiffPage(newPage);
    }
}

function updatePageNavigation() {
    const prevBtn = document.getElementById('diffPrevPage');
    const nextBtn = document.getElementById('diffNextPage');
    const currentPageEl = document.getElementById('diffCurrentPage');
    
    // Update button states
    prevBtn.disabled = diffViewerState.currentPage === 0;
    nextBtn.disabled = diffViewerState.currentPage >= diffViewerState.totalPages - 1;
    
    // Highlight current page if it has changes
    // Note: affectedPages are 1-indexed, currentPage is 0-indexed, so add 1 for comparison
    const pageHasChanges = diffViewerState.affectedPages.includes(diffViewerState.currentPage + 1);
    if (pageHasChanges) {
        currentPageEl.style.color = 'var(--warning)';
        currentPageEl.style.fontWeight = '700';
    } else {
        currentPageEl.style.color = '';
        currentPageEl.style.fontWeight = '';
    }
}

function closeDiffViewer() {
    const modal = document.getElementById('diffModal');
    modal.classList.remove('active');
    document.body.style.overflow = '';
}

// Close modal on Escape key, navigate pages with arrow keys
document.addEventListener('keydown', function(e) {
    const modal = document.getElementById('diffModal');
    if (!modal.classList.contains('active')) {
        return;
    }
    
    if (e.key === 'Escape') {
        closeDiffViewer();
    } else if (e.key === 'ArrowLeft') {
        e.preventDefault();
        changeDiffPage(-1);
    } else if (e.key === 'ArrowRight') {
        e.preventDefault();
        changeDiffPage(1);
    }
});

async function approveChange(changeId) {
    const notes = prompt('Optional: Add review notes (or leave blank):');
    
    try {
        const url = `/api/changes/${changeId}/approve` + (notes ? `?notes=${encodeURIComponent(notes)}` : '');
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            // Reload page to show updated status
            location.reload();
        } else {
            alert(`Failed to approve: ${data.detail || 'Unknown error'}`);
        }
    } catch (error) {
        alert(`Error: ${error.message}`);
    }
}

async function unapproveChange(changeId) {
    if (!confirm('Remove approval from this change?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/changes/${changeId}/unapprove`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            location.reload();
        } else {
            alert(`Failed to unapprove: ${data.detail || 'Unknown error'}`);
        }
    } catch (error) {
        alert(`Error: ${error.message}`);
    }
}

// Load similar forms
async function loadSimilarForms() {
    const similarFormsCard = document.getElementById('similar-forms-card');
    const similarFormsContent = document.getElementById('similar-forms-content');
    
    try {
        const response = await fetch(`/api/urls/{{ url.id }}/similar?max_results=5`);
        const data = await response.json();
        
        if (response.ok && data.success && data.results && data.results.length > 0) {
            similarFormsCard.style.display = 'block';
            
            let html = '<div style="display: grid; gap: 12px;">';
            for (const result of data.results) {
                html += `
                    <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 8px; border: 1px solid var(--border);">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                            <h4 style="margin: 0; font-size: 16px;">
                                <a href="/url/${result.url_id}" style="color: var(--accent); text-decoration: none;">
                                    ${result.title || result.url_name}
                                </a>
                            </h4>
                            <span style="font-size: 12px; color: var(--text-secondary);">
                                ${Math.round(result.relevance_score * 100)}% match
                            </span>
                        </div>
                        ${result.form_number ? `<div style="color: var(--text-secondary); font-size: 14px; margin-bottom: 8px;">Form: ${result.form_number}</div>` : ''}
                        ${result.excerpt ? `<div style="color: var(--text-secondary); font-size: 13px; line-height: 1.5; margin-bottom: 8px;">${result.excerpt.substring(0, 150)}${result.excerpt.length > 150 ? '...' : ''}</div>` : ''}
                        <div style="display: flex; gap: 12px; font-size: 12px; color: var(--text-secondary);">
                            <a href="${result.url}" target="_blank" style="color: var(--accent); text-decoration: none;">View PDF ‚Üí</a>
                            ${result.state ? `<span>State: ${result.state}</span>` : ''}
                        </div>
                    </div>
                `;
            }
            html += '</div>';
            similarFormsContent.innerHTML = html;
        } else {
            // Hide if no results or error
            similarFormsCard.style.display = 'none';
        }
    } catch (error) {
        console.error('Error loading similar forms:', error);
        similarFormsCard.style.display = 'none';
    }
}

// Load similar forms on page load
loadSimilarForms();
</script>
{% endblock %}
