{% extends "base.html" %}

{% block title %}Dashboard - PDF Monitor{% endblock %}

{% block content %}
<h1>Monitored URLs</h1>

{% if message %}
<div class="card" style="margin-bottom: 24px; {% if message_type == 'error' %}background: rgba(244, 33, 46, 0.1); border-left: 4px solid var(--error);{% else %}background: rgba(0, 186, 124, 0.1); border-left: 4px solid var(--success);{% endif %}">
    <div style="display: flex; align-items: center; gap: 12px;">
        <span style="font-size: 1.5rem;">{% if message_type == 'error' %}‚ùå{% else %}‚úÖ{% endif %}</span>
        <div>
            <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">
                {% if message_type == 'error' %}Error{% else %}Success{% endif %}
            </div>
            <div style="color: var(--text-secondary); font-size: 0.9rem;">{{ message }}</div>
        </div>
    </div>
</div>
{% endif %}

{% if urls %}
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-value">{{ urls|length }}</div>
        <div class="stat-label">Total URLs</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ urls|selectattr('url.enabled')|list|length }}</div>
        <div class="stat-label">Enabled</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ urls|sum(attribute='version_count') }}</div>
        <div class="stat-label">Total Versions</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ urls|selectattr('recent_change')|list|length }}</div>
        <div class="stat-label">With Changes</div>
    </div>
</div>

<div class="card">
    <table>
        <thead>
            <tr>
                <th style="width: 60px;">Preview</th>
                <th>Name / Formatted Title</th>
                <th>Status</th>
                <th>Versions</th>
                <th>Last Checked</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for item in urls %}
            <tr class="{% if item.recent_change and item.recent_change.change_type != 'new' and not item.recent_change.reviewed %}row-changed{% endif %}{% if item.recent_change and item.recent_change.relocated_from_url and not item.recent_change.reviewed %} row-relocated{% endif %}">
                <td>
                    {% if item.latest_version %}
                    <a href="/url/{{ item.url.id }}" title="View details">
                        <img src="/api/urls/{{ item.url.id }}/versions/{{ item.latest_version.id }}/preview" 
                             alt="Preview" 
                             class="preview-thumbnail"
                             style="width: 50px; height: 65px; object-fit: cover; border: 1px solid var(--border); border-radius: 4px;"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div style="display: none; width: 50px; height: 65px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 4px; align-items: center; justify-content: center; font-size: 1.5rem;">üìÑ</div>
                    </a>
                    {% else %}
                    <div style="width: 50px; height: 65px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">üìÑ</div>
                    {% endif %}
                </td>
                <td>
                    <div class="card-title">{{ item.url.name }}</div>
                    {% if item.latest_version and item.latest_version.formatted_title %}
                    <div style="margin-top: 4px;">
                        {# Display title in PoC format: "Title {FormNumber}" #}
                        <span style="color: var(--text-primary); font-weight: 500;">{{ item.latest_version.display_title or item.latest_version.formatted_title }}</span>
                        {% if item.latest_version.title_confidence %}
                        <span style="color: var(--text-secondary); font-size: 0.75rem; margin-left: 6px;">
                            {{ (item.latest_version.title_confidence * 100)|round|int }}% confidence
                        </span>
                        {% endif %}
                    </div>
                    {% if item.latest_version.revision_date %}
                    <div style="margin-top: 2px; font-size: 0.75rem; color: var(--text-secondary);">
                        Rev. {{ item.latest_version.revision_date }}
                    </div>
                    {% endif %}
                    {% endif %}
                    <div class="card-subtitle">
                        <a href="{{ item.url.url }}" target="_blank" class="url-link">{{ item.url.url[:50] }}{% if item.url.url|length > 50 %}...{% endif %}</a>
                        {% if item.recent_change and item.recent_change.relocated_from_url %}
                        <div style="margin-top: 6px; padding: 6px; background: rgba(255, 200, 0, 0.15); border-left: 3px solid #ffc800; border-radius: 4px; font-size: 0.75rem;">
                            <div style="color: var(--text-secondary); margin-bottom: 2px;">üìç URL Changed:</div>
                            <div style="color: var(--text-primary);">
                                <span style="text-decoration: line-through; opacity: 0.6;">{{ item.recent_change.relocated_from_url[:45] }}{% if item.recent_change.relocated_from_url|length > 45 %}...{% endif %}</span>
                                <span style="margin: 0 4px;">‚Üí</span>
                                <span style="font-weight: 600;">{{ item.url.url[:45] }}{% if item.url.url|length > 45 %}...{% endif %}</span>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </td>
                <td>
                    {% if item.url.enabled %}
                        {% if item.recent_change and item.recent_change.change_type != 'new' and not item.recent_change.reviewed %}
                            {# Unapproved change - show as Changed with pending review #}
                            <div class="change-info">
                                <span class="badge badge-warning">{{ item.recent_change.change_type|replace('_', ' ')|title }}</span>
                                
                                {% if item.recent_change.match_type %}
                                <div style="margin-top: 6px; font-size: 0.75rem;">
                                    {# PoC-aligned classification labels #}
                                    {% if item.recent_change.match_type == 'form_number_match' %}
                                        <span class="badge badge-success" style="font-size: 0.65rem;">üìã Updated Form (Same Name)</span>
                                    {% elif item.recent_change.match_type == 'similarity_match' %}
                                        <span class="badge badge-info" style="font-size: 0.65rem;">üìä Updated Form (Name Change)</span>
                                    {% elif item.recent_change.match_type == 'new_form' %}
                                        <span class="badge badge-error" style="font-size: 0.65rem;">üÜï New Form</span>
                                    {% elif item.recent_change.match_type == 'uncertain' %}
                                        <span class="badge badge-warning" style="font-size: 0.65rem;">‚ùì Needs Review</span>
                                    {% else %}
                                        <span class="badge badge-neutral" style="font-size: 0.65rem;">{{ item.recent_change.match_type|replace('_', ' ')|title }}</span>
                                    {% endif %}
                                </div>
                                {% endif %}
                                
                                {% if item.recent_change.similarity_score %}
                                <div style="margin-top: 4px; font-size: 0.7rem; color: var(--text-secondary);">
                                    {{ (item.recent_change.similarity_score * 100)|round|int }}% similar
                                </div>
                                {% endif %}
                                
                                {% if item.recent_change.relocated_from_url %}
                                <div style="margin-top: 6px; padding: 6px; background: rgba(255, 200, 0, 0.15); border-left: 3px solid #ffc800; border-radius: 4px;">
                                    <div style="font-size: 0.65rem; color: var(--text-secondary); margin-bottom: 2px;">üìç URL Changed</div>
                                    <div style="font-size: 0.6rem; color: var(--text-primary); line-height: 1.3;">
                                        <div style="text-decoration: line-through; opacity: 0.6;">{{ item.recent_change.relocated_from_url[:30] }}{% if item.recent_change.relocated_from_url|length > 30 %}...{% endif %}</div>
                                        <div style="font-weight: 600; margin-top: 2px;">‚Üí {{ item.url.url[:30] }}{% if item.url.url|length > 30 %}...{% endif %}</div>
                                    </div>
                                </div>
                                {% endif %}
                                
                                <div style="margin-top: 4px;">
                                    <span class="badge badge-neutral" style="font-size: 0.65rem; background: var(--bg-tertiary);">‚è≥ Pending Review</span>
                                </div>
                            </div>
                        {% elif item.version_count > 0 %}
                            {# Either no changes, approved change, or initial version - show as Unchanged #}
                            <span class="badge badge-success">Unchanged</span>
                            {% if item.recent_change and item.recent_change.reviewed %}
                            <div style="margin-top: 4px; font-size: 0.7rem; color: var(--text-secondary);">
                                ‚úÖ Last change approved
                            </div>
                            {% endif %}
                        {% else %}
                            <span class="badge badge-info">New</span>
                        {% endif %}
                    {% else %}
                        <span class="badge badge-neutral">Disabled</span>
                    {% endif %}
                </td>
                <td>{{ item.version_count }}</td>
                <td>
                    {% if item.url.last_checked_at %}
                        <span class="timestamp">{{ item.url.last_checked_at.strftime('%Y-%m-%d %H:%M') }}</span>
                    {% else %}
                        <span class="timestamp">Never</span>
                    {% endif %}
                </td>
                <td>
                    <a href="/url/{{ item.url.id }}" class="btn btn-secondary btn-sm">View Details</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% else %}
<div class="card">
    <div class="empty-state">
        <div class="empty-state-icon">üìã</div>
        <h2>No URLs Monitored</h2>
        <p>Run <code>python cli.py seed</code> to add sample URLs, then <code>python cli.py run</code> to start monitoring.</p>
    </div>
</div>
{% endif %}

<div style="margin-top: 24px;">
    <form id="monitorForm" action="/monitor/run" method="post" style="display: inline;" onsubmit="showMonitoringProgress()">
        <button type="submit" id="monitorBtn" class="btn btn-primary">
            ‚ñ∂ Run Monitoring Cycle
        </button>
    </form>
    <div id="monitorProgress" style="display: none; margin-top: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 6px;">
        <div style="display: flex; align-items: center; gap: 12px;">
            <div style="width: 20px; height: 20px; border: 3px solid var(--accent); border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <span style="color: var(--text-primary);">Running monitoring cycle... This may take a moment.</span>
        </div>
    </div>
</div>

<script>
function showMonitoringProgress() {
    const btn = document.getElementById('monitorBtn');
    const progress = document.getElementById('monitorProgress');
    
    btn.disabled = true;
    btn.innerHTML = '‚è≥ Running...';
    progress.style.display = 'block';
    
    // The form will submit and redirect, but this gives immediate feedback
}

// Add spinner animation
const style = document.createElement('style');
style.textContent = `
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
`;
document.head.appendChild(style);

// Auto-hide success message after 5 seconds
{% if message and message_type == 'success' %}
setTimeout(function() {
    const msgDiv = document.querySelector('.card[style*="border-left: 4px solid var(--success)"]');
    if (msgDiv) {
        msgDiv.style.transition = 'opacity 0.5s';
        msgDiv.style.opacity = '0';
        setTimeout(() => msgDiv.remove(), 500);
    }
}, 5000);

// Scroll to top to show message
window.scrollTo({ top: 0, behavior: 'smooth' });
{% endif %}

// Force refresh if refresh parameter is present (remove it from URL)
if (window.location.search.includes('refresh=') || window.location.search.includes('error=')) {
    // Clean up URL after a moment
    setTimeout(function() {
        const url = new URL(window.location);
        url.searchParams.delete('refresh');
        url.searchParams.delete('error');
        window.history.replaceState({}, '', url);
    }, 100);
}
</script>
{% endblock %}

