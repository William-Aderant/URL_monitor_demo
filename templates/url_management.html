{% extends "base.html" %}

{% block title %}URL Management - PDF Monitor{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
    <h1 style="margin-bottom: 0;">URL Management</h1>
    <div style="display: flex; align-items: center; gap: 16px;">
        {# Schedule Status Indicator #}
        <div id="scheduleStatus" class="card" style="padding: 12px 20px; margin-bottom: 0; display: flex; align-items: center; gap: 12px;">
            {% if scheduler_status.scheduler_running and scheduler_status.config and scheduler_status.config.enabled %}
            <div style="width: 10px; height: 10px; background: var(--success); border-radius: 50%; animation: pulse 2s infinite;"></div>
            <span style="font-size: 0.875rem;">
                Next run: <strong>{{ scheduler_status.next_run[:16] if scheduler_status.next_run else 'Not scheduled' }}</strong>
            </span>
            {% else %}
            <div style="width: 10px; height: 10px; background: var(--warning); border-radius: 50%;"></div>
            <span style="font-size: 0.875rem; color: var(--text-secondary);">Scheduler disabled</span>
            {% endif %}
            <button class="btn btn-secondary btn-sm" onclick="openScheduleModal()">Configure</button>
        </div>
        
        {# Run Now Button #}
        <button id="runNowBtn" class="btn btn-primary" onclick="triggerManualCycle()">
            ‚ñ∂ Run Cycle Now
        </button>
    </div>
</div>

{# Filter and Search Bar #}
<div class="card" style="margin-bottom: 24px; padding: 16px;">
    <div style="display: flex; flex-wrap: wrap; gap: 16px; align-items: center;">
        {# State Filter #}
        <div style="display: flex; align-items: center; gap: 8px;">
            <label style="font-weight: 500; white-space: nowrap;">State:</label>
            <select id="stateFilter" onchange="applyFilters()" style="padding: 8px 12px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                <option value="">All States</option>
                {% for state_name, count in state_counts %}
                <option value="{{ state_name }}" {% if current_state == state_name %}selected{% endif %}>{{ state_name }} ({{ count }})</option>
                {% endfor %}
            </select>
        </div>
        
        {# Domain Filter #}
        <div style="display: flex; align-items: center; gap: 8px;">
            <label style="font-weight: 500; white-space: nowrap;">Jurisdiction:</label>
            <select id="domainFilter" onchange="applyFilters()" style="padding: 8px 12px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                <option value="">All Jurisdictions</option>
                {% for domain_name, count in domain_counts %}
                <option value="{{ domain_name }}" {% if current_domain == domain_name %}selected{% endif %}>{{ domain_name }} ({{ count }})</option>
                {% endfor %}
            </select>
        </div>
        
        {# Search #}
        <div style="flex: 1; min-width: 200px;">
            <input type="text" id="searchInput" value="{{ search_query or '' }}" placeholder="Search by name or URL..." 
                   style="width: 100%; padding: 8px 12px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);"
                   oninput="filterTable()">
        </div>
    </div>
</div>

{# Action Buttons #}
<div style="margin-bottom: 24px; display: flex; gap: 12px; flex-wrap: wrap;">
    <button class="btn btn-primary" onclick="openAddUrlModal()">+ Add URL</button>
    <button class="btn btn-secondary" onclick="openBulkUploadModal()">üì§ Bulk Upload</button>
    <button id="deleteSelectedBtn" class="btn btn-secondary" onclick="deleteSelected()" disabled style="opacity: 0.5;">üóëÔ∏è Delete Selected</button>
</div>

{# URL Table #}
{% if urls %}
<div class="card" style="overflow-x: auto;">
    <table id="urlTable" class="url-table">
        <thead>
            <tr>
                <th class="col-checkbox">
                    <input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)">
                </th>
                <th class="col-name">Title / Name</th>
                <th class="col-url">URL</th>
                <th class="col-state">State</th>
                <th class="col-status">Status</th>
                <th class="col-stats">Ver</th>
                <th class="col-stats">Chg</th>
                <th class="col-actions">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for item in urls %}
            <tr class="url-row" data-id="{{ item.url.id }}" data-name="{{ item.url.name|lower }}" data-url="{{ item.url.url|lower }}">
                <td class="col-checkbox">
                    <input type="checkbox" class="row-checkbox" value="{{ item.url.id }}" onchange="updateDeleteButton()">
                </td>
                <td class="col-name">
                    <div class="editable-cell" data-field="name" data-id="{{ item.url.id }}">
                        <span class="cell-value cell-truncate" title="{{ item.url.name }}">{{ item.url.name }}</span>
                        <button class="edit-btn" onclick="makeEditable(this)" title="Edit">‚úèÔ∏è</button>
                    </div>
                </td>
                <td class="col-url">
                    <div class="editable-cell" data-field="url" data-id="{{ item.url.id }}">
                        <span class="cell-value cell-truncate">
                            <a href="{{ item.url.url }}" target="_blank" class="url-link" title="{{ item.url.url }}">{{ item.url.url }}</a>
                        </span>
                        <button class="edit-btn" onclick="makeEditable(this)" title="Edit">‚úèÔ∏è</button>
                    </div>
                </td>
                <td class="col-state">
                    <span class="cell-truncate" title="{{ item.url.state or '' }}{% if item.url.domain_category %} - {{ item.url.domain_category }}{% endif %}">
                        {{ item.url.state or '-' }}
                    </span>
                </td>
                <td class="col-status">
                    {% if item.url.enabled %}
                    <span class="badge badge-success">Active</span>
                    {% else %}
                    <span class="badge badge-neutral">Off</span>
                    {% endif %}
                </td>
                <td class="col-stats">{{ item.version_count }}</td>
                <td class="col-stats">
                    {% if item.pending_changes > 0 %}
                    <span class="badge badge-warning">{{ item.pending_changes }}</span>
                    {% else %}
                    0
                    {% endif %}
                </td>
                <td class="col-actions">
                    <div class="action-buttons">
                        <a href="/url/{{ item.url.id }}" class="action-btn" title="View Details">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                        </a>
                        <button class="action-btn" onclick="toggleUrl({{ item.url.id }}, {{ 'false' if item.url.enabled else 'true' }})" title="{{ 'Disable' if item.url.enabled else 'Enable' }}">
                            {% if item.url.enabled %}
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>
                            {% else %}
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                            {% endif %}
                        </button>
                        <button class="action-btn action-btn-danger" onclick="deleteUrl({{ item.url.id }})" title="Delete">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                        </button>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="card">
    <div class="empty-state">
        <div class="empty-state-icon">üìã</div>
        <h2>No URLs Found</h2>
        <p>Add URLs to start monitoring.</p>
        <div style="margin-top: 16px; display: flex; gap: 12px; justify-content: center;">
            <button class="btn btn-primary" onclick="openAddUrlModal()">+ Add URL</button>
            <button class="btn btn-secondary" onclick="openBulkUploadModal()">üì§ Bulk Upload</button>
        </div>
    </div>
</div>
{% endif %}

{# Add URL Modal #}
<div id="addUrlModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Add New URL</h2>
            <button onclick="closeModal('addUrlModal')" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-secondary);">&times;</button>
        </div>
        <form id="addUrlForm" onsubmit="submitAddUrl(event)">
            <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500;">URL *</label>
                <input type="url" name="url" required placeholder="https://example.com/form.pdf" 
                       style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
            </div>
            <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500;">Title (optional)</label>
                <input type="text" name="name" placeholder="Form Title" 
                       style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                <div>
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">State *</label>
                    <input type="text" name="state" required placeholder="California" 
                           style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Jurisdiction *</label>
                    <input type="text" name="domain_category" required placeholder="courts.ca.gov" 
                           style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                </div>
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 12px;">
                <button type="button" class="btn btn-secondary" onclick="closeModal('addUrlModal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Add URL</button>
            </div>
        </form>
    </div>
</div>

{# Bulk Upload Modal #}
<div id="bulkUploadModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h2>Bulk Upload URLs</h2>
            <button onclick="closeModal('bulkUploadModal')" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-secondary);">&times;</button>
        </div>
        <div style="margin-bottom: 16px;">
            <p style="color: var(--text-secondary); margin-bottom: 16px;">Upload a CSV or TXT file with URLs to monitor.</p>
            <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 6px; margin-bottom: 16px;">
                <strong>CSV Format:</strong>
                <pre style="margin: 8px 0; font-size: 0.8rem; overflow-x: auto;">URL,Title,State,Jurisdiction
https://example.com/form.pdf,Form Title,California,courts.ca.gov</pre>
                <p style="font-size: 0.8rem; color: var(--text-secondary);">Title is optional. State and Jurisdiction are required.</p>
            </div>
            <a href="/api/urls/upload-template" class="btn btn-secondary btn-sm" download>üì• Download Template</a>
        </div>
        <form id="bulkUploadForm" onsubmit="submitBulkUpload(event)" enctype="multipart/form-data">
            <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500;">Select File</label>
                <input type="file" name="file" accept=".csv,.txt" required 
                       style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
            </div>
            <div id="uploadProgress" style="display: none; margin-bottom: 16px;">
                <div style="background: var(--bg-tertiary); border-radius: 4px; overflow: hidden;">
                    <div id="uploadProgressBar" style="height: 8px; background: var(--accent); width: 0%; transition: width 0.3s;"></div>
                </div>
                <p id="uploadStatus" style="margin-top: 8px; font-size: 0.875rem; color: var(--text-secondary);"></p>
            </div>
            <div id="uploadResults" style="display: none; margin-bottom: 16px;"></div>
            <div style="display: flex; justify-content: flex-end; gap: 12px;">
                <button type="button" class="btn btn-secondary" onclick="closeModal('bulkUploadModal')">Cancel</button>
                <button type="submit" class="btn btn-primary" id="uploadBtn">Upload</button>
            </div>
        </form>
    </div>
</div>

{# Schedule Configuration Modal #}
<div id="scheduleModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Schedule Configuration</h2>
            <button onclick="closeModal('scheduleModal')" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-secondary);">&times;</button>
        </div>
        <form id="scheduleForm" onsubmit="submitSchedule(event)">
            <div style="margin-bottom: 16px;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" name="enabled" id="scheduleEnabled" {% if scheduler_status.config and scheduler_status.config.enabled %}checked{% endif %}>
                    <span style="font-weight: 500;">Enable Automatic Scheduling</span>
                </label>
            </div>
            <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500;">Schedule Type</label>
                <select name="schedule_type" id="scheduleType" onchange="updateScheduleFields()" 
                        style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                    <option value="daily" {% if scheduler_status.config and scheduler_status.config.schedule_type == 'daily' %}selected{% endif %}>Daily</option>
                    <option value="weekly" {% if scheduler_status.config and scheduler_status.config.schedule_type == 'weekly' %}selected{% endif %}>Weekly</option>
                    <option value="custom" {% if scheduler_status.config and scheduler_status.config.schedule_type == 'custom' %}selected{% endif %}>Custom (Cron)</option>
                </select>
            </div>
            <div id="dailyFields" style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500;">Time (24-hour)</label>
                <input type="time" name="daily_time" value="{{ scheduler_status.config.daily_time if scheduler_status.config else '02:00' }}" 
                       style="padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
            </div>
            <div id="weeklyFields" style="display: none; margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500;">Days</label>
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                    {% for day in ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'] %}
                    <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
                        <input type="checkbox" name="weekly_days" value="{{ day }}" {% if scheduler_status.config and scheduler_status.config.weekly_days and day in scheduler_status.config.weekly_days %}checked{% endif %}>
                        {{ day|capitalize }}
                    </label>
                    {% endfor %}
                </div>
                <div style="margin-top: 12px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Time (24-hour)</label>
                    <input type="time" name="weekly_time" value="{{ scheduler_status.config.weekly_time if scheduler_status.config else '02:00' }}" 
                           style="padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                </div>
            </div>
            <div id="customFields" style="display: none; margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500;">Cron Expression</label>
                <input type="text" name="cron_expression" placeholder="0 2 * * *" value="{{ scheduler_status.config.cron_expression if scheduler_status.config else '' }}"
                       style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                <p style="margin-top: 4px; font-size: 0.8rem; color: var(--text-secondary);">Format: minute hour day month weekday</p>
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 12px;">
                <button type="button" class="btn btn-secondary" onclick="closeModal('scheduleModal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Schedule</button>
            </div>
        </form>
    </div>
</div>

<style>
/* Table Layout */
.url-table {
    width: 100%;
    table-layout: fixed;
    border-collapse: collapse;
}

.url-table th,
.url-table td {
    padding: 12px 8px;
    text-align: left;
    vertical-align: middle;
    border-bottom: 1px solid var(--border);
}

.url-table th {
    font-weight: 600;
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-secondary);
    background: var(--bg-tertiary);
    position: sticky;
    top: 0;
}

/* Column Widths */
.col-checkbox { width: 40px; text-align: center; }
.col-name { width: 30%; min-width: 200px; }
.col-url { width: 35%; min-width: 200px; }
.col-state { width: 100px; }
.col-status { width: 70px; text-align: center; }
.col-stats { width: 50px; text-align: center; }
.col-actions { width: 120px; }

/* Truncation */
.cell-truncate {
    display: block;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    max-width: 100%;
}

.col-name .cell-truncate {
    max-width: calc(100% - 30px);
}

.col-url .cell-truncate {
    max-width: calc(100% - 30px);
}

.col-url .url-link {
    color: var(--accent);
    text-decoration: none;
}

.col-url .url-link:hover {
    text-decoration: underline;
}

/* Editable Cells */
.editable-cell {
    display: flex;
    align-items: center;
    gap: 6px;
    min-width: 0;
}

.edit-btn {
    flex-shrink: 0;
    background: none;
    border: none;
    cursor: pointer;
    opacity: 0;
    transition: opacity 0.2s;
    font-size: 0.75rem;
    padding: 2px;
}

.editable-cell:hover .edit-btn {
    opacity: 0.7;
}

.edit-btn:hover {
    opacity: 1 !important;
}

/* Action Buttons */
.action-buttons {
    display: flex;
    gap: 6px;
    justify-content: flex-start;
}

.action-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    padding: 0;
    background: var(--bg-tertiary);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.2s;
    text-decoration: none;
}

.action-btn:hover {
    background: var(--accent);
    border-color: var(--accent);
    color: white;
}

.action-btn-danger:hover {
    background: var(--error);
    border-color: var(--error);
}

.action-btn svg {
    width: 16px;
    height: 16px;
}

/* Row States */
.url-row:hover {
    background: var(--bg-tertiary);
}

.url-row.selected {
    background: rgba(29, 155, 240, 0.1);
}

/* Modal Styles */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal-content {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 24px;
    max-width: 500px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.modal-header h2 {
    margin: 0;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

/* Responsive adjustments */
@media (max-width: 1200px) {
    .col-name { width: 25%; }
    .col-url { width: 30%; }
}
</style>

<script>
function applyFilters() {
    const state = document.getElementById('stateFilter').value;
    const domain = document.getElementById('domainFilter').value;
    let url = '/url-management?';
    if (state) url += `state=${encodeURIComponent(state)}&`;
    if (domain) url += `domain=${encodeURIComponent(domain)}&`;
    window.location.href = url.slice(0, -1);
}

function filterTable() {
    const query = document.getElementById('searchInput').value.toLowerCase();
    document.querySelectorAll('.url-row').forEach(row => {
        const name = row.dataset.name || '';
        const url = row.dataset.url || '';
        row.style.display = !query || name.includes(query) || url.includes(query) ? '' : 'none';
    });
}

function toggleSelectAll(checkbox) {
    document.querySelectorAll('.row-checkbox').forEach(cb => {
        cb.checked = checkbox.checked;
    });
    updateDeleteButton();
}

function updateDeleteButton() {
    const checked = document.querySelectorAll('.row-checkbox:checked').length;
    const btn = document.getElementById('deleteSelectedBtn');
    btn.disabled = checked === 0;
    btn.style.opacity = checked === 0 ? '0.5' : '1';
}

function openModal(id) {
    document.getElementById(id).style.display = 'flex';
}

function closeModal(id) {
    document.getElementById(id).style.display = 'none';
}

function openAddUrlModal() { openModal('addUrlModal'); }
function openBulkUploadModal() { openModal('bulkUploadModal'); }
function openScheduleModal() { 
    updateScheduleFields();
    openModal('scheduleModal'); 
}

function updateScheduleFields() {
    const type = document.getElementById('scheduleType').value;
    document.getElementById('dailyFields').style.display = type === 'daily' ? 'block' : 'none';
    document.getElementById('weeklyFields').style.display = type === 'weekly' ? 'block' : 'none';
    document.getElementById('customFields').style.display = type === 'custom' ? 'block' : 'none';
}

async function submitAddUrl(e) {
    e.preventDefault();
    const form = e.target;
    const data = {
        name: form.name.value || 'Untitled URL',
        url: form.url.value,
        state: form.state.value,
        domain_category: form.domain_category.value
    };
    
    try {
        const response = await fetch('/api/urls', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            window.location.reload();
        } else {
            const error = await response.json();
            alert('Error: ' + (error.detail || 'Failed to add URL'));
        }
    } catch (err) {
        alert('Error: ' + err.message);
    }
}

async function submitBulkUpload(e) {
    e.preventDefault();
    const form = e.target;
    const formData = new FormData(form);
    
    const progress = document.getElementById('uploadProgress');
    const progressBar = document.getElementById('uploadProgressBar');
    const status = document.getElementById('uploadStatus');
    const results = document.getElementById('uploadResults');
    const btn = document.getElementById('uploadBtn');
    
    progress.style.display = 'block';
    results.style.display = 'none';
    btn.disabled = true;
    status.textContent = 'Uploading...';
    progressBar.style.width = '50%';
    
    try {
        const response = await fetch('/api/urls/bulk-upload', {
            method: 'POST',
            body: formData
        });
        
        progressBar.style.width = '100%';
        const data = await response.json();
        
        if (data.success || data.successful > 0) {
            status.textContent = `Uploaded: ${data.successful} successful, ${data.failed} failed, ${data.duplicates} duplicates`;
            results.innerHTML = `<div class="badge badge-success">Successfully added ${data.successful} URLs</div>`;
            results.style.display = 'block';
            
            setTimeout(() => window.location.reload(), 2000);
        } else {
            status.textContent = 'Upload failed';
            results.innerHTML = `<div class="badge badge-error">${data.error || 'Unknown error'}</div>`;
            results.style.display = 'block';
            btn.disabled = false;
        }
    } catch (err) {
        status.textContent = 'Upload failed';
        results.innerHTML = `<div class="badge badge-error">${err.message}</div>`;
        results.style.display = 'block';
        btn.disabled = false;
    }
}

async function submitSchedule(e) {
    e.preventDefault();
    const form = e.target;
    const weeklyDays = Array.from(form.querySelectorAll('input[name="weekly_days"]:checked')).map(cb => cb.value);
    
    const data = {
        enabled: form.enabled.checked,
        schedule_type: form.schedule_type.value,
        daily_time: form.daily_time.value,
        weekly_days: weeklyDays,
        weekly_time: form.weekly_time.value,
        cron_expression: form.cron_expression.value
    };
    
    try {
        const response = await fetch('/api/schedule', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            window.location.reload();
        } else {
            const error = await response.json();
            alert('Error: ' + (error.detail || 'Failed to update schedule'));
        }
    } catch (err) {
        alert('Error: ' + err.message);
    }
}

async function triggerManualCycle() {
    const btn = document.getElementById('runNowBtn');
    btn.disabled = true;
    btn.innerHTML = '‚è≥ Starting...';
    
    try {
        const response = await fetch('/api/monitor/run-now', { method: 'POST' });
        const data = await response.json();
        
        if (data.success) {
            btn.innerHTML = '‚úì Cycle Started';
            setTimeout(() => {
                btn.innerHTML = '‚ñ∂ Run Cycle Now';
                btn.disabled = false;
            }, 3000);
        } else {
            alert('Error: ' + (data.error || 'Failed to start cycle'));
            btn.innerHTML = '‚ñ∂ Run Cycle Now';
            btn.disabled = false;
        }
    } catch (err) {
        alert('Error: ' + err.message);
        btn.innerHTML = '‚ñ∂ Run Cycle Now';
        btn.disabled = false;
    }
}

async function toggleUrl(id, enable) {
    try {
        const response = await fetch(`/api/urls/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ enabled: enable })
        });
        
        if (response.ok) {
            window.location.reload();
        } else {
            alert('Failed to update URL');
        }
    } catch (err) {
        alert('Error: ' + err.message);
    }
}

async function deleteUrl(id) {
    if (!confirm('Are you sure you want to delete this URL and all its versions?')) return;
    
    try {
        const response = await fetch(`/api/urls/${id}`, { method: 'DELETE' });
        
        if (response.ok) {
            window.location.reload();
        } else {
            alert('Failed to delete URL');
        }
    } catch (err) {
        alert('Error: ' + err.message);
    }
}

async function deleteSelected() {
    const ids = Array.from(document.querySelectorAll('.row-checkbox:checked')).map(cb => parseInt(cb.value));
    if (ids.length === 0) return;
    
    if (!confirm(`Are you sure you want to delete ${ids.length} URLs?`)) return;
    
    try {
        const response = await fetch('/api/urls/bulk-delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url_ids: ids })
        });
        
        if (response.ok) {
            window.location.reload();
        } else {
            alert('Failed to delete URLs');
        }
    } catch (err) {
        alert('Error: ' + err.message);
    }
}

function makeEditable(btn) {
    const cell = btn.closest('.editable-cell');
    const field = cell.dataset.field;
    const id = cell.dataset.id;
    const valueSpan = cell.querySelector('.cell-value');
    const currentValue = valueSpan.textContent.trim();
    
    const input = document.createElement('input');
    input.type = field === 'url' ? 'url' : 'text';
    input.value = field === 'url' ? cell.querySelector('a').href : currentValue;
    input.style.cssText = 'width: 100%; padding: 4px 8px; background: var(--bg-tertiary); border: 1px solid var(--accent); border-radius: 4px; color: var(--text-primary);';
    
    input.onblur = () => saveEdit(cell, field, id, input.value);
    input.onkeydown = (e) => {
        if (e.key === 'Enter') input.blur();
        if (e.key === 'Escape') window.location.reload();
    };
    
    valueSpan.replaceWith(input);
    btn.style.display = 'none';
    input.focus();
    input.select();
}

async function saveEdit(cell, field, id, value) {
    try {
        const response = await fetch(`/api/urls/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ [field]: value })
        });
        
        if (response.ok) {
            window.location.reload();
        } else {
            const error = await response.json();
            alert('Error: ' + (error.detail || 'Failed to update'));
            window.location.reload();
        }
    } catch (err) {
        alert('Error: ' + err.message);
        window.location.reload();
    }
}

// Initialize
updateScheduleFields();
</script>
{% endblock %}
